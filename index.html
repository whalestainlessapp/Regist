<!DOCTYPE html>
<html lang="th">
<head>
   <meta charset="UTF-8">
   <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
   <title>ลงทะเบียนพนักงาน</title>
   <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
   <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
   <style>
       body {
           font-family: Arial, sans-serif;
           padding: 20px;
       }
       input[type=text], input[type=email], select {
           width: 100%;
           padding: 12px 20px;
           margin: 8px 0;
           display: block;
           border: 1px solid #ccc;
           border-radius: 4px;
           box-sizing: border-box;
       }
       button {
           width: 100%;
           background-color: #4CAF50;
           color: white;
           padding: 14px 20px;
           margin: 8px 0;
           border: none;
           border-radius: 4px;
           cursor: pointer;
       }
       button:hover {
           background-color: #45a049;
       }
       button:disabled {
           background-color: #cccccc;
           cursor: not-allowed;
       }
       h1 {
           text-align: center;
       }
       label {
           font-weight: bold;
       }
       .readonly {
           background-color: #f5f5f5;
           cursor: not-allowed;
       }
       .status-message {
           text-align: center;
           padding: 15px;
           margin: 10px 0;
           border-radius: 5px;
           font-weight: bold;
       }
       .status-registered {
           background-color: #d4edda;
           color: #155724;
           border: 1px solid #c3e6cb;
       }
   </style>
</head>
<body>

<h1>ลงทะเบียนพนักงาน</h1>

<div id="statusMessage" class="status-message" style="display: none;"></div>

<form id="registerForm">
   <label for="department">แผนก:</label>
   <select id="department" name="department" required>
       <option value="">เลือกแผนก...</option>
       <option value="ซ่อมบำรุง">ซ่อมบำรุง</option>
       <option value="ฝ่ายผลิต">ฝ่ายผลิต</option>
       <option value="เลเซอร์">เลเซอร์</option>
       <option value="ฝ่ายขาย">ฝ่ายขาย</option>
       <option value="ประกอบ1">ประกอบ1</option>
       <option value="ประกอบ2">ประกอบ2</option>
       <option value="ประกอบ3">ประกอบ3</option>
       <option value="บัญชี-การเงิน">บัญชี-การเงิน</option>
       <option value="ฝ่ายจัดซื้อ">ฝ่ายจัดซื้อ</option>
       <option value="ฝ่ายบุคคล">ฝ่ายบุคคล</option>
        <option value="ฝ่ายควบคุมเอกสาร">ควบคุมเอกสาร</option>
      <option value="ฝ่ายขนส่ง">ขนส่ง</option>
       <option value="ฝ่ายวิศวกรรม">ฝ่ายวิศวกรรม</option>
       <option value="ฝ่ายแพ็คกิ้ง">แพ็คกิ้ง</option>
       <option value="ขัดลบคม">ขัดลบคม</option>
       <option value="หน้าร้าน">หน้าร้าน</option>
       <option value="ติดตั้ง">ติดตั้ง</option>
       <option value="สโตร์">สโตร์</option>
       <option value="QC">QC</option>
   </select>

   <label for="name">ชื่อพนักงาน:</label>
   <input type="text" id="name" name="name" placeholder="กรอกชื่อพนักงาน..." required>

   <label for="employeeId">รหัสพนักงาน:</label>
   <input type="text" id="employeeId" name="employeeId" placeholder="กรอกรหัสพนักงาน..." required>

   <label for="email">อีเมล:</label>
   <input type="email" id="email" name="email" placeholder="กรอกอีเมล...">

   <button type="submit" id="submitBtn">ลงทะเบียน</button>
</form>

<script>
   let userId, displayName, pictureUrl;
   let isUserRegistered = false;

   // เริ่มต้น LIFF
   liff.init({ liffId: "2006299650-mYgagPnO" })
       .then(() => {
           if (!liff.isLoggedIn()) {
               liff.login();
           } else {
               return liff.getProfile();
           }
       })
       .then(profile => {
           userId = profile.userId;
           displayName = profile.displayName;
           pictureUrl = profile.pictureUrl;
           fetchUserData(userId);
       })
       .catch(err => {
           console.error("LIFF initialization failed", err);
       });

   // ฟังก์ชันดึงข้อมูลผู้ใช้จาก Google Script
   function fetchUserData(userId) {
       fetch("https://script.google.com/macros/s/AKfycbziwaFq0ZMdcmFrgNXVXvPLThTz1L5H1vip-dmbsNHIvD78xs01puhs0rYbaQjYfape/exec?userId=" + userId, {
           method: "GET"
       })
       .then(response => response.json())
       .then(data => {
           console.log("User data response:", data);
           
           if (data.status === 'success' && data.userExists) {
               // ผู้ใช้ลงทะเบียนแล้ว
               isUserRegistered = true;
               showRegisteredStatus(data.user);
               populateForm(data.user);
               disableForm();
           } else {
               // ผู้ใช้ยังไม่ลงทะเบียน
               isUserRegistered = false;
               enableForm();
           }
       })
       .catch(error => {
           console.error("Error fetching user data:", error);
           // ถ้าเกิด error ให้ใช้งานฟอร์มได้ปกติ
           enableForm();
       });
   }

   // แสดงสถานะว่าลงทะเบียนแล้ว
   function showRegisteredStatus(userData) {
       const statusDiv = document.getElementById("statusMessage");
       statusDiv.innerHTML = `
           <div class="status-registered">
               ✅ คุณได้ลงทะเบียนไปแล้ว<br>
               <small>ชื่อ: ${userData.name || 'ไม่ระบุ'} | แผนก: ${userData.department || 'ไม่ระบุ'}</small>
           </div>
       `;
       statusDiv.style.display = "block";
   }

   // เติมข้อมูลในฟอร์ม
   function populateForm(userData) {
       document.getElementById("department").value = userData.department || "";
       document.getElementById("name").value = userData.name || "";
       document.getElementById("employeeId").value = userData.employeeId || "";
       document.getElementById("email").value = userData.email || "";
   }

   // ปิดการใช้งานฟอร์ม
   function disableForm() {
       const inputs = document.querySelectorAll("input, select, button");
       inputs.forEach(input => {
           input.disabled = true;
           if (input.type !== 'submit') {
               input.classList.add('readonly');
           }
       });
       
       document.getElementById("submitBtn").textContent = "ลงทะเบียนแล้ว";
       document.getElementById("submitBtn").style.backgroundColor = "#6c757d";
   }

   // เปิดการใช้งานฟอร์ม
   function enableForm() {
       const inputs = document.querySelectorAll("input, select, button");
       inputs.forEach(input => {
           input.disabled = false;
           input.classList.remove('readonly');
       });
       
       document.getElementById("submitBtn").textContent = "ลงทะเบียน";
       document.getElementById("submitBtn").style.backgroundColor = "#4CAF50";
   }

   document.getElementById("registerForm").addEventListener("submit", function(event) {
       event.preventDefault();

       // ตรวจสอบว่าผู้ใช้ลงทะเบียนแล้วหรือไม่
       if (isUserRegistered) {
           Swal.fire({
               title: 'แจ้งเตือน',
               text: 'คุณได้ลงทะเบียนไปแล้ว',
               icon: 'info',
               confirmButtonText: 'ตกลง'
           });
           return;
       }

       const data = {
           displayName: displayName,
           userId: userId,
           pictureUrl: pictureUrl,
           department: document.getElementById("department").value,
           name: document.getElementById("name").value,
           employeeId: document.getElementById("employeeId").value,
           email: document.getElementById("email").value,
           timestamp: new Date().toLocaleString("th-TH")
       };

       console.log("Sending data:", data);

       // ใช้ JSONP แทน fetch เพื่อหลีกเลี่ยงปัญหา CORS
       submitWithJsonp(data);
   });

   // ฟังก์ชันส่งข้อมูลแบบ JSONP
   function submitWithJsonp(data) {
       const script = document.createElement('script');
       const callbackName = 'callback' + Date.now();
       
       // สร้าง callback function
       window[callbackName] = function(response) {
           console.log("JSONP response:", response);
           
           if (response.status === 'success') {
               Swal.fire({
                   title: 'สำเร็จ',
                   text: 'ข้อมูลถูกบันทึกเรียบร้อยแล้ว',
                   icon: 'success',
                   confirmButtonText: 'ปิด'
               }).then(() => {
                   liff.closeWindow();
               });
           } else if (response.userExists) {
               // ผู้ใช้ลงทะเบียนแล้ว
               isUserRegistered = true;
               if (response.existingData) {
                   showRegisteredStatus(response.existingData);
                   populateForm(response.existingData);
               }
               disableForm();
               
               Swal.fire({
                   title: 'แจ้งเตือน',
                   text: response.message || 'คุณได้ลงทะเบียนไปแล้ว',
                   icon: 'info',
                   confirmButtonText: 'ตกลง'
               });
           } else {
               Swal.fire({
                   title: 'เกิดข้อผิดพลาด',
                   text: response.message || 'ไม่สามารถบันทึกข้อมูลได้',
                   icon: 'error',
                   confirmButtonText: 'ตกลง'
               });
           }
           
           // ลบ script tag และ callback function
           document.head.removeChild(script);
           delete window[callbackName];
       };

       // สร้าง URL สำหรับ JSONP
       const params = new URLSearchParams({
           callback: callbackName,
           data: JSON.stringify(data)
       });
       
       script.src = `https://script.google.com/macros/s/AKfycbziwaFq0ZMdcmFrgNXVXvPLThTz1L5H1vip-dmbsNHIvD78xs01puhs0rYbaQjYfape/exec?${params}`;
       script.onerror = function() {
           Swal.fire({
               title: 'เกิดข้อผิดพลาด',
               text: 'ไม่สามารถเชื่อมต่อกับเซิร์ฟเวอร์ได้',
               icon: 'error',
               confirmButtonText: 'ตกลง'
           });
           document.head.removeChild(script);
           delete window[callbackName];
       };
       
       document.head.appendChild(script);
   }
</script>

</body>
</html>
