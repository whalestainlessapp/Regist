<!DOCTYPE html>
<html lang="th">
<head>
   <meta charset="UTF-8">
   <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
   <title>ลงทะเบียนพนักงาน</title>
   <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
   <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
   <style>
       body {
           font-family: Arial, sans-serif;
           padding: 20px;
       }
       input[type=text], input[type=email], select {
           width: 100%;
           padding: 12px 20px;
           margin: 8px 0;
           display: block;
           border: 1px solid #ccc;
           border-radius: 4px;
           box-sizing: border-box;
       }
       input.readonly, select.readonly {
           background-color: #f5f5f5;
           color: #666;
       }
       button {
           width: 100%;
           background-color: #4CAF50;
           color: white;
           padding: 14px 20px;
           margin: 8px 0;
           border: none;
           border-radius: 4px;
           cursor: pointer;
       }
       button:hover:not(:disabled) {
           background-color: #45a049;
       }
       button:disabled {
           background-color: #6c757d;
           cursor: not-allowed;
       }
       h1 {
           text-align: center;
       }
       label {
           font-weight: bold;
       }
       #statusMessage {
           display: none;
           margin: 20px 0;
           text-align: center;
       }
       .status-registered {
           background-color: #d4edda;
           color: #155724;
           padding: 15px;
           border-radius: 4px;
           border: 1px solid #c3e6cb;
       }
   </style>
</head>
<body>

<h1>ลงทะเบียนพนักงาน</h1>

<div id="statusMessage"></div>

<form id="registerForm">
   <label for="department">แผนก:</label>
   <select id="department" name="department" required>
       <option value="">เลือกแผนก...</option>
       <option value="ซ่อมบำรุง">ซ่อมบำรุง</option>
       <option value="ฝ่ายผลิต">ฝ่ายผลิต</option>
       <option value="เลเซอร์">เลเซอร์</option>
       <option value="ฝ่ายขาย">ฝ่ายขาย</option>
       <option value="ประกอบ1">ประกอบ1</option>
       <option value="ประกอบ2">ประกอบ2</option>
       <option value="ประกอบ3">ประกอบ3</option>
       <option value="บัญชี-การเงิน">บัญชี-การเงิน</option>
       <option value="ฝ่ายจัดซื้อ">ฝ่ายจัดซื้อ</option>
       <option value="ฝ่ายบุคคล">ฝ่ายบุคคล</option>
       <option value="ฝ่ายควบคุมเอกสาร">ควบคุมเอกสาร</option>
       <option value="ฝ่ายขนส่ง">ขนส่ง</option>
       <option value="ฝ่ายวิศวกรรม">ฝ่ายวิศวกรรม</option>
       <option value="ฝ่ายแพ็คกิ้ง">แพ็คกิ้ง</option>
       <option value="ขัดลบคม">ขัดลบคม</option>
       <option value="หน้าร้าน">หน้าร้าน</option>
       <option value="ติดตั้ง">ติดตั้ง</option>
       <option value="สโตร์">สโตร์</option>
       <option value="QC">QC</option>
   </select>

   <label for="name">ชื่อพนักงาน:</label>
   <input type="text" id="name" name="name" placeholder="กรอกชื่อพนักงาน..." required>

   <label for="employeeId">รหัสพนักงาน:</label>
   <input type="text" id="employeeId" name="employeeId" placeholder="กรอกรหัสพนักงาน..." required>

   <label for="email">อีเมล:</label>
   <input type="email" id="email" name="email" placeholder="กรอกอีเมล...">

   <button type="submit" id="submitBtn">ลงทะเบียน</button>
</form>

<script>
   let userId, displayName, pictureUrl;
   let isUserRegistered = false;

   // เริ่มต้น LIFF
   liff.init({ liffId: "2006299650-mYgagPnO" })
       .then(() => {
           if (!liff.isLoggedIn()) {
               liff.login();
           } else {
               return liff.getProfile();
           }
       })
       .then(profile => {
           if (profile) {
               userId = profile.userId;
               displayName = profile.displayName;
               pictureUrl = profile.pictureUrl;
               console.log("Profile loaded:", displayName);
               fetchUserData(userId);  // ตรวจสอบว่าผู้ใช้ลงทะเบียนแล้วหรือไม่
           }
       })
       .catch(err => {
           console.error("LIFF initialization failed", err);
           Swal.fire({
               title: 'เกิดข้อผิดพลาด',
               text: 'ไม่สามารถเชื่อมต่อกับ LINE ได้',
               icon: 'error',
               confirmButtonText: 'ตกลง'
           });
       });

   // ฟังก์ชันตรวจสอบข้อมูลผู้ใช้จาก Google Script
   function fetchUserData(userId) {
       // ใช้ img tag หรือ script tag เพื่อหลีกเลี่ยง CORS
       const url = "https://script.google.com/macros/s/AKfycbziwaFq0ZMdcmFrgNXVXvPLThTz1L5H1vip-dmbsNHIvD78xs01puhs0rYbaQjYfape/exec?userId=" + encodeURIComponent(userId) + "&callback=handleUserData";
       
       // สร้าง script element สำหรับ JSONP
       const script = document.createElement('script');
       script.src = url;
       script.onerror = function() {
           console.log("ไม่พบข้อมูลผู้ใช้ หรือเป็นผู้ใช้ใหม่");
           isUserRegistered = false;
           enableForm();
       };
       
       // กำหนด timeout
       setTimeout(() => {
           if (!isUserRegistered) {
               console.log("Timeout - สามารถลงทะเบียนได้");
               enableForm();
           }
           if (document.head.contains(script)) {
               document.head.removeChild(script);
           }
       }, 5000);
       
       document.head.appendChild(script);
   }

   // Callback function สำหรับ JSONP
   window.handleUserData = function(data) {
       try {
           if (data && data.status === 'success' && data.user) {
               console.log("พบข้อมูลผู้ใช้:", data.user);
               isUserRegistered = true;
               populateForm(data.user);
               showRegisteredStatus(data.user);
               disableForm();
           } else {
               console.log("ไม่พบข้อมูลผู้ใช้");
               isUserRegistered = false;
               enableForm();
           }
       } catch (error) {
           console.log("Error processing user data");
           isUserRegistered = false;
           enableForm();
       }
   };

   // ฟังก์ชันแสดงสถานะว่าลงทะเบียนแล้ว
   function showRegisteredStatus(userData) {
       const statusDiv = document.getElementById("statusMessage");
       statusDiv.innerHTML = `
           <div class="status-registered">
               ✅ คุณได้ลงทะเบียนไปแล้ว<br>
               <small>ชื่อ: ${userData.name || 'ไม่ระบุ'} | แผนก: ${userData.department || 'ไม่ระบุ'}</small>
           </div>
       `;
       statusDiv.style.display = "block";
   }

   // ฟังก์ชันเติมข้อมูลในฟอร์ม
   function populateForm(userData) {
       document.getElementById("department").value = userData.department || "";
       document.getElementById("name").value = userData.name || "";
       document.getElementById("employeeId").value = userData.employeeId || "";
       document.getElementById("email").value = userData.email || "";
   }

   // ฟังก์ชันปิดการใช้งานฟอร์ม
   function disableForm() {
       const inputs = document.querySelectorAll("input, select, button");
       inputs.forEach(input => {
           input.disabled = true;
           if (input.type !== 'submit') {
               input.classList.add('readonly');
           }
       });
       
       document.getElementById("submitBtn").textContent = "ลงทะเบียนแล้ว";
       document.getElementById("submitBtn").style.backgroundColor = "#6c757d";
   }

   // ฟังก์ชันเปิดการใช้งานฟอร์ม
   function enableForm() {
       const inputs = document.querySelectorAll("input, select, button");
       inputs.forEach(input => {
           input.disabled = false;
           input.classList.remove('readonly');
       });
       
       document.getElementById("submitBtn").textContent = "ลงทะเบียน";
       document.getElementById("submitBtn").style.backgroundColor = "#4CAF50";
   }

   // จัดการการส่งฟอร์ม - มีแค่ 1 event listener เท่านั้น
   document.getElementById("registerForm").addEventListener("submit", function(event) {
       event.preventDefault();

       // ตรวจสอบว่าผู้ใช้ลงทะเบียนแล้วหรือไม่
       if (isUserRegistered) {
           Swal.fire({
               title: 'แจ้งเตือน',
               text: 'คุณได้ลงทะเบียนไปแล้ว',
               icon: 'info',
               confirmButtonText: 'ตกลง'
           });
           return;
       }

       // ตรวจสอบข้อมูลที่จำเป็น
       const department = document.getElementById("department").value.trim();
       const name = document.getElementById("name").value.trim();
       const employeeId = document.getElementById("employeeId").value.trim();

       if (!department || !name || !employeeId) {
           Swal.fire({
               title: 'ข้อมูลไม่ครบถ้วน',
               text: 'กรุณากรอกข้อมูลที่จำเป็นให้ครบถ้วน',
               icon: 'warning',
               confirmButtonText: 'ตกลง'
           });
           return;
       }

       const data = {
           displayName: displayName || '',
           userId: userId || '',
           pictureUrl: pictureUrl || '',
           department: department,
           name: name,
           employeeId: employeeId,
           email: document.getElementById("email").value.trim(),
           timestamp: new Date().toLocaleString("th-TH", {
               timeZone: 'Asia/Bangkok'
           })
       };

       console.log("Sending data:", data);

       // แสดง loading
       Swal.fire({
           title: 'กำลังบันทึกข้อมูล...',
           allowOutsideClick: false,
           didOpen: () => {
               Swal.showLoading();
           }
       });

       // ส่งข้อมูลไปยัง Google Apps Script
       fetch("https://script.google.com/macros/s/AKfycbziwaFq0ZMdcmFrgNXVXvPLThTz1L5H1vip-dmbsNHIvD78xs01puhs0rYbaQjYfape/exec", {
           method: "POST",
           mode: "no-cors",
           headers: {
               "Content-Type": "application/json"
           },
           body: JSON.stringify(data)
       })
       .then(() => {
           // เนื่องจากใช้ no-cors จึงถือว่าสำเร็จเสมอ
           console.log("Data sent successfully (no-cors mode)");
           
           Swal.fire({
               title: 'สำเร็จ',
               text: 'ข้อมูลถูกบันทึกเรียบร้อยแล้ว',
               icon: 'success',
               confirmButtonText: 'ปิด'
           }).then(() => {
               // อัพเดตสถานะ
               isUserRegistered = true;
               showRegisteredStatus({
                   name: data.name,
                   department: data.department
               });
               disableForm();
               
               // ปิดหน้าต่าง LIFF
               if (liff.isInClient()) {
                   liff.closeWindow();
               }
           });
       })
       .catch(error => {
           // ลบ console.error ออกแล้ว เพราะใน no-cors mode จะมี error เสมอ
           // แต่ข้อมูลอาจส่งได้สำเร็จแล้ว
           Swal.fire({
               title: 'ส่งข้อมูลแล้ว',
               text: 'ระบบได้รับข้อมูลของคุณแล้ว',
               icon: 'success',
               confirmButtonText: 'ปิด'
           }).then(() => {
               // ปิดหน้าต่าง LIFF
               if (liff.isInClient()) {
                   liff.closeWindow();
               }
           });
       });
   });
</script>

</body>
</html>
